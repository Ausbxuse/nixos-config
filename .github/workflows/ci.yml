name: CI

on:
  push:
  pull_request:

jobs:
  nix:
    runs-on: ubuntu-latest
    env:
      SYSTEM: x86_64-linux
      NIX_OVERRIDES: >-
        --override-input nix-secrets path:./.ci/nix-secrets
        --override-input bootstrap-keys path:./.ci/bootstrap-keys
    steps:
      - uses: actions/checkout@v4

      - uses: cachix/install-nix-action@v27
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Eval
        run: nix flake show --all-systems $NIX_OVERRIDES

      - name: Lint (alejandra)
        run: |
          nix shell nixpkgs#alejandra -c alejandra --check .

      - name: Build system closures
        run: |
          HOSTS=$(nix eval --json .#nixosConfigurations --apply 'builtins.attrNames' $NIX_OVERRIDES | jq -r '.[]')
          for host in $HOSTS; do
            nix build .#nixosConfigurations.${host}.config.system.build.toplevel $NIX_OVERRIDES
          done

      - name: NixOS VM tests (major services)
        run: |
          for test in gnome printing pipewire; do
            nix build .#checks.${SYSTEM}.${test} $NIX_OVERRIDES
          done
